****

# LL-INT（低负载网络带内遥测）



## 1 框架说明

### 1.1 定义新的 Ethernet Type

由于IPv6已经取消掉了IP头部字段中的可选项，因此不考虑使用IP头部中的选项字段作为INT数据的插入部分。

(如果实验允许，可以做对比实验，看看定义新的Ethernet Type和在IP头部可选字段中插入INT对网络性能的影响会是多少。主要涉及支持INT交换机对数据报的处理时效问题。)



### 1.2 实验进阶

- [ ] **对于每一条流，实现部分流承载部分信息，使得在接收端能够汇聚而获取到全网整体信息。**





##  2 代码说明

### 2.1 流表项

通过mycontroller.py利用p4runtime来下发流表项。

* ingress部分：

  > **table ipv4_exact**: 进行`最短路径`路由；
  >
  > **table egress_to_host**: 判断出端口是否对应主机，如果是，则删除添加的遥测信息；

* egress部分：

  > **table swid**: 设置交换机的id号，供遥测信息添加；
  >
  > **table set_bitmap**: 设置网络遥测信息的内容，供交换机判断。
### 2.2 流程

给边缘交换机对应端是主机的端口添加egress流表项，使交换机将中间的添加的遥测信息给提取出来。

| is out to host? |  egress action  |
| :-------------: | :-------------: |
|       no        |  add INT info   |
|       yes       | delete INT info |





## 3 需要写进论文中的概念

### 3.1 网速测量

使用**0.05秒**内的平均网速。从交换机启动后的第一个包到达交换机开始，若某个数据包到达交换机后，其时间距离上一次计算网速已经超过了**50ms**，则从新计算网速，并记录在寄存器中，供后续数据包使用。

不在每个包到达交换机的时候都计算，是因为若每个包都计算，存在偏差过大的情况。

- [ ] **待证明：**需要证明该计算方法理论可行性；
  
  | 倍数 | 时间间隔 | 向下区间内系数 |
  | :---: | :------: | :------------: |
  |  20  |   0.05   |       20       |
  |  19  | 0.052632 |       19       |
  |  18  | 0.055556 |       18       |
  |  17  | 0.058823 |       17       |
  |  16  | 0.062500 |       16       |
  |  15  | 0.066667 |       15       |
  |  14  | 0.071429 |       14       |
  |  13  | 0.076923 |       13       |
  |  12  | 0.083333 |       12       |
  |  11  | 0.090909 |       11       |
  |  10  | 0.100000 |       -        |



### 3.2 头部字段解析

|                  有INT                   |      没有INT      |
| :--------------------------------------: | :---------------: |
|            Ethernet (0x1727)             | ethernet (0x0800) |
|                length (n)                |       IPv4        |
|                bitmap (1)                |        ...        |
|                   ...                    |                   |
|                bitmap (n)                |                   |
| INT_info_A / INT_info_B / INT_info_C (1) |                   |
|                   ...                    |                   |
| INT_info_A / INT_info_B / INT_info_C (n) |                   |
|                   IPv4                   |                   |
|                   ...                    |                   |

- [ ] 构建双栈结构，形成不同bitmap对应的不同长度的头部字段；

### 3.3 bitmap对应表

|   bitmap   |  对应头部  |     测量内容      |
| :--------: | :--------: | :---------------: |
| 0b00000000 | intInfos_A |     固定部分      |
| 0b00000001 | intInfos_B |      +丢包率      |
| 0b00000010 | intInfos_C |       +时延       |
| 0b00000011 | intInfos_D |   +时延+丢包率    |
| 0b00000100 | intInfos_E |       +网速       |
| 0b00000101 | intInfos_F |   +网速+丢包率    |
| 0b00000110 | intInfos_G |    +网速+时延     |
| 0b00000111 | intInfos_H | +网速+时延+丢包率 |



## 4 代解决问题

### 4.1 代码

#### 4.1.1 my-int.lua

​    该文件为支持wireshark解析遥测信息的插件，复制到wireshark安装位置，并在init.lua文件最后添加一行引入的代码：

```lua
dofile(DATA_DIR.."my-int.lua")
```

- [ ] 如果修改了bitmap对应表，以及各遥测字段长度，则my-int.lua需要进行相应的更改

### 4.2 实验

- [ ] 吞吐量的测量：使用iperf时，如果在测UDP以及TCP不指定从窗口大小的情况下，无法测吞吐量。流量是以MTU(以太网最大传输单元，1500B)（以太网帧的数据部分长度，即IP数据报不能超过1500字节，如果超过，需要对IP数据报进行分片）进行发送，导致在入口交换机处由于添加INT头部字段导致超出最大帧长度限制，交换机没有进行端口转发。

- [ ] 阶段实验数据

  |     -     |    INT    |  no INT   |
  | :-------: | :-------: | :-------: |
  |   时延    |  27.5 ms  |  7.6 ms   |
  | 吞吐量udp | 17.6 Mbps | 40.5 Mbps |
  | 吞吐量TCP | 9.96 Mbps | 22.7 Mbps |




1.FINT网络带宽占用**(bandwidth occupation)**

h9: ITGRecv -l recv_log_file

h1: ITGSend -a 10.0.3.1 -C 100 -v 1 300 -t 10000

2.



## 历史版本

1. 20211202：适当优化；
2. 20211128：修正多个数据包占用bitmap_task_ramain问题;
3. 20211127：修正bitmap_need = bitmap_need <<  1;
4. 20211126：修正cmr.p4 bitmap_task_remain逻辑问题；
5. 20211124：修正MTU-packet.len-3-3*max_hops导致出现负数的情况；
6. 20211123：修改克隆包的大小，减小INT收集对；
7. 20211122：开始INT-label融入；
8. 20211119：修改逻辑bug；
9. 20211116：修改bug；
10. 20211109：修改bug，经过最后一个交换机不添加遥测元数据问题；
11. 20211106：完成int_swtich.p4程序调试，FINT搭建完成。头部字段结构：

   | type | count | bitmap_need | -- | bitmap_add n | length |    metadata       | ...

   ​    2 bit    6 bit      (8 * type) bit            (8 * type) bit       8bit        (8 * length) bit

11. 20211104：修改bitmap接续结构：

   | bitmap_need | count | -- | bitmap_add n | length |    metadata       | ...

   ​      4 bit                    4bit                   4 bit                 4bit     8 * length bit

11. 20211103：修改双bitmap解析结构；

   | **bitmap_need** | **count** |   --   | **bitmap_add n** |**bitmap_add n-1** | ** | **bitmap_add 1** |   -- | **md** |

   

11. 20210906：完善packet in消息解析，支持对INT消息的解封装，可以获取内部参数信息；修改bitmap以及count的位置信息；

12. 20210901-2：部分代码完善；

13. 20210901：构建数据平面与控制平面独立，dataplane文件夹“make”后根据topology生成p4的mininet环境，controller文件夹内“make”后根据topology生成相应的流量表项，并利用指令下发到交换机上。

14. 20210823：使用数据包在出口队列中的时间消耗作为链路时延参数（单位：微妙），同步修改wireshark解析；

15. 20210818：添加wireshark的解析支持；

16. 20210812：完善bitmap机制，可以实现控制器下发流表项的方式，来控制交换机执行部分弹性的数据采样；

17. 20210811-1：修正传输数据报字节统计方式，将新添加的遥测信息头部字段加入统计中；

18. 20210810：实现端口实时速率的遥测；

19. 20210809：修改ingress、egress逻辑；

20. 20210728：能够添加基本的遥测数据，并实现支持的交换机进行添加，在网络边缘交换机中出口处删除遥测信息。

